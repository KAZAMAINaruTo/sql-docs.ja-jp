---
title: "AlwaysOn 可用性グループのレプリカ インスタンスのアップグレード | Microsoft Docs"
ms.custom: ""
ms.date: "05/17/2016"
ms.prod: "sql-server-2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dbe-high-availability"
ms.tgt_pltfrm: ""
ms.topic: "article"
ms.assetid: f670af56-dbcc-4309-9119-f919dcad8a65
caps.latest.revision: 14
author: "MikeRayMSFT"
ms.author: "mikeray"
manager: "jhubbard"
caps.handback.revision: 14
---
# AlwaysOn 可用性グループのレプリカ インスタンスのアップグレード
[!INCLUDE[tsql-appliesto-ss2016-xxxx-xxxx-xxx_md](../../../includes/tsql-appliesto-ss2016-xxxx-xxxx-xxx-md.md)]

  [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Always On 可用性グループを新しい [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] バージョン、新しい [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] サービス パックまたは累積更新プログラムにアップグレードしている場合、または新しい Windows サービス パックまたは累積更新プログラムにインストールしている場合、ローリング アップグレードを実行して、単一の手動フェールオーバー (または、元のプライマリにフェールバックする場合は、2 回の手動フェールオーバー) におけるプライマリ レプリカのダウンタイムを減らすことができます。 アップグレード プロセス中に、セカンダリ レプリカはフェールオーバーや読み取り専用操作を行うことができなくなります。また、アップグレード後は、プライマリ レプリカ ノード上のアクティビティ量に応じて、プライマリ レプリカ ノードを検出するセカンダリ レプリカの時間がかかる場合があります (そのため、高いネットワーク トラフィック量が予想されます)。  
  
> [!NOTE]  
>  ここでは、SQL Server 自体のアップグレードについてのみ説明します。 これには、Windows Server フェールオーバー クラスタリング (WSFC) のクラスターを含む、オペレーティング システムのアップグレードは含まれません。 フェールオーバー クラスターをホストしている Windows オペレーティング システムのアップグレードは、Windows Server 2012 R2 より前のオペレーティング システムではサポートされません。 Windows Server 2012 R2 で実行されているクラスター ノードのアップグレードについては、「[Cluster Operating System Rolling Upgrade (クラスター オペレーティング システムのローリング アップグレード)](https://technet.microsoft.com/library/dn850430.aspx)」を参照してください。  
  
## 前提条件  
 作業を開始する前に、次の重要な情報を確認してください。  
  
-   [Supported Version and Edition Upgrades](../../../database-engine/install-windows/supported-version-and-edition-upgrades.md): 自分のバージョンの Windows オペレーティング システムと SQL Server から SQL Server 2016 にアップグレードできることを確認します。 たとえば、SQL Server 2005 インスタンスから [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)]に直接アップグレードすることはできません。  
  
-   [Choose a Database Engine Upgrade Method](../../../database-engine/install-windows/choose-a-database-engine-upgrade-method.md): サポートされるバージョンとエディションのアップグレードに基づいて、適切なアップグレードの方法と手順を選択します。また、自分の環境にインストールされているその他のコンポーネントに基づいて、正しい順序でコンポーネントをアップグレードします。  
  
-   [データベース エンジンのアップグレード計画の策定およびテスト](../../../database-engine/install-windows/plan-and-test-the-database-engine-upgrade-plan.md): リリース ノート、アップグレードに関する既知の問題、アップグレード前のチェックリストを確認して、アップグレードの計画を作成およびテストします。  
  
-   [SQL Server 2016 のインストールに必要なハードウェアおよびソフトウェア](../../../sql-server/install/hardware-and-software-requirements-for-installing-sql-server-2016.md): [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] をインストールするためのソフトウェア要件を確認します。 その他のソフトウェアが必要な場合は、ダウンタイムを最小限に抑えるために、アップグレード プロセスを開始する前に、各ノードにソフトウェアをインストールします。  
  
## AlwaysOn 可用性グループのローリング アップグレードのベスト プラクティス  
 サーバーのアップグレード時に可用性グループのダウンタイムとデータ損失を最小限に抑えるには、次のベスト プラクティスに従ってください。  
  
-   ローリング アップグレードを開始する前に、次の操作を実行します。  
  
    -   少なくとも 1 つの同期コミット レプリカ インスタンスで試験的に手動フェールオーバーを実行する。  
  
    -   すべての可用性データベースを対象にデータベースの完全バックアップを実行し、データを保護する。  
  
    -   すべての可用性データベースに対して DBCC CHECKDB コマンドを実行する。  
  
-   常に、最初はリモートのセカンダリ レプリカ ノード、次にローカルのセカンダリ レプリカ インスタンス、最後にプライマリ レプリカ インスタンスという順序でアップグレードしてください。  
  
-   アップグレード中のデータベースでバックアップを実行することはできません。  セカンダリ レプリカをアップグレードする前に、プライマリ レプリカでのみバックアップを実行するように自動バックアップ設定を構成します。  バージョンのアップグレード中に、レプリカをバックアップ用に読み取ったり、使用したりすることはできません。 バージョン以外のアップグレード時には、プライマリ レプリカをアップグレードする前に、セカンダリ レプリカで実行するように自動化されたバックアップを構成できます。  
  
-   バージョン アップグレード時に、読み取り可能なセカンダリのアップグレード後、または、プライマリ レプリカがアップグレード済みのセカンダリにフェールオーバーされるか、プライマリ レプリカがアップグレードされる前のいずれかに、読み取り可能なセカンダリを読み取ることはできません。  
  
-   アップグレード プロセスの間に可用性グループが誤ってフェールオーバーされることを防ぐために、作業開始前にすべての同期コミット レプリカから可用性フェールオーバーを削除してください。  
  
-   最初にセカンダリ レプリカを使用して可用性グループをアップグレード済みインスタンスにフェールオーバーした後で、プライマリ レプリカ インスタンスをアップグレードするようにしてください。 このベスト プラクティスに従わなかった場合、プライマリ レプリカ インスタンスでのアップグレード時にクライアント アプリケーションで長時間のダウンタイムが発生する可能性があります。  
  
-   可用性グループは常に同期コミット セカンダリ レプリカ インスタンスにフェールオーバーしてください。 非同期コミット セカンダリ レプリカ インスタンスにフェールオーバーした場合、データベースでデータ損失が発生し、データ移動が自動的に中断されます。データ移動を再開するには、手動で操作する必要があります。  
  
-   他のセカンダリ レプリカ インスタンスをアップグレードまたは更新する前に、プライマリ レプリカ インスタンスをアップグレードしないでください。 アップグレードされたプライマリ レプリカから、同じバージョンにまだアップグレードされていない [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] インスタンスのあるセカンダリ レプリカにログを送信できなくなります。 セカンダリ レプリカへのデータ移動が中断されているときには、そのレプリカに対する自動フェールオーバーは実行されず、可用性データベースでデータ損失が発生する危険性が高まります。  
  
-   可用性グループをフェールオーバーする前に、フェールオーバー ターゲットの同期状態が SYNCHRONIZED であることを確認してください。  
  
## ローリング アップグレード プロセス  
 実際のプロセスは、可用性グループの配置トポロジや各レプリカのコミット モードなどの要因によって変わります。 ただし、最も単純なシナリオにおけるローリング アップグレードは、次の手順で構成される単純な複数段階のプロセスになります。  
  
 ![HADR シナリオの可用性グループのアップグレード](../../../database-engine/availability-groups/windows/media/alwaysonupgrade-ag-hadr.gif "HADR シナリオの可用性グループのアップグレード")  
  
1.  すべての同期コミット レプリカの自動フェールオーバーを削除する。  
  
2.  非同期コミット セカンダリ レプリカを実行しているリモート セカンダリ サーバー インスタンスをすべてアップグレードする。  
  
3.  プライマリ レプリカを現在実行していないローカルのレプリカ セカンダリ インスタンスをすべてアップグレードする。  
  
4.  可用性グループを手動でローカルの同期コミット セカンダリ レプリカにフェールオーバーする。  
  
5.  それまでプライマリ レプリカをホストしていたローカルのレプリカ インスタンスをアップグレードまたは更新する。  
  
6.  必要に応じて自動フェールオーバー パートナーを構成する。  
  
 必要であれば、さらに手動でフェールオーバーを実行して、可用性グループを元の構成に戻すこともできます。  
  
## 1 つのリモート セカンダリ レプリカを含む可用性グループ  
 災害復旧のみを目的として可用性グループを配置していた場合、可用性グループを非同期コミット セカンダリ レプリカにフェールオーバーする必要がある場合があります。 次の図に、そのような構成の例を示します。  
  
 ![DR シナリオの可用性グループのアップグレード](../../../database-engine/availability-groups/windows/media/agupgrade-ag-dr.gif "DR シナリオの可用性グループのアップグレード")  
  
 この場合には、ローリング アップグレード時に可用性グループを非同期コミット セカンダリ レプリカにフェールオーバーする必要があります。 データ損失を防ぐために、コミット モードを同期コミットに変更し、セカンダリ レプリカが同期されるまで待ってから、可用性グループをフェールオーバーします。 そのため、ローリング アップグレードのプロセスは次のようになります。  
  
1.  リモート サイトのセカンダリ レプリカ インスタンスをアップグレードする。  
  
2.  コミット モードを同期コミットに変更する。  
  
3.  同期状態が SYNCHRONIZED になるまで待機する。  
  
4.  可用性グループをリモート サイトのセカンダリ レプリカにフェールオーバーする。  
  
5.  ローカル (プライマリ サイト) のレプリカ インスタンスをアップグレードまたは更新する。  
  
6.  可用性グループをプライマリ サイトにフェールオーバーして戻す。  
  
7.  コミット モードを非同期コミットに変更する。  
  
 同期コミット モードはリモート サイトとのデータ同期には推奨されない設定であるため、設定の変更後、クライアント アプリケーションでデータベース待機時間が急増する可能性があります。 さらに、フェールオーバーを実行すると未確認のログ メッセージがすべて破棄されます。 2 つのサイト間のネットワーク待機時間が長い場合、破棄されるログ メッセージの数が膨大になり、クライアントで大量のトランザクション エラーが発生する可能性があります。 クライアント アプリケーションへの影響を最小限に抑えるには、次の操作を行います。  
  
-   クライアント トラフィックが少ない時間帯にメンテナンス予定を設定する。  
  
-   プライマリ サイトの [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] をアップグレードまたは更新するときに、可用性モードを非同期コミットに戻し、もう一度プライマリ サイトへのフェールオーバーの準備が完了したときに、同期コミットに戻す。  
  
## フェールオーバー クラスター インスタンス ノードを含む可用性グループ  
 可用性グループにフェールオーバー クラスター インスタンス (FCI) ノードが含まれている場合、非アクティブなノードをアップグレードした後で、アクティブなノードをアップグレードする必要があります。 次の図では、ローカルでの可用性を高めるために FCI を使用し、リモートの災害復旧のために FCI 間の非同期コミットを使用する、一般的な可用性グループのシナリオを示します。さらに、アップグレード手順も示しています。  
  
 ![FCI による可用性グループのアップグレード:](../../../database-engine/availability-groups/windows/media/agupgrade-ag-fci-dr.gif "FCI による可用性グループのアップグレード:")  
  
1.  REMOTE2 をアップグレードまたは更新する。  
  
2.  FCI2 を REMOTE2 にフェールオーバーする。  
  
3.  REMOTE1 をアップグレードまたは更新する。  
  
4.  PRIMARY2 をアップグレードまたは更新する。  
  
5.  FCI1 を PRIMARY2 にフェールオーバーする。  
  
6.  PRIMARY1 をアップグレードまたは更新する。  
  
## 複数の可用性グループを含む SQL Server インスタンスのアップグレードまたは更新  
 プライマリ レプリカが別々のサーバー ノードに存在する (アクティブ/アクティブ構成) 可用性グループが複数実行されている場合、アップグレード時にはプロセスの高可用性を維持するためのフェールオーバー手順を追加で実行する必要があります。 次の表に示すように、3 つのサーバー ノードで 3 つの可用性グループが実行され、すべてのセカンダリ レプリカが同期コミット モードで実行されているとします。  
  
|可用性グループ|Node1|Node2|Node3|  
|------------------------|-----------|-----------|-----------|  
|AG1|プライマリ|||  
|AG2||プライマリ||  
|AG3|||プライマリ|  
  
 この状況では、次の順序で負荷分散ローリング アップグレードを実行することが適切であると考えられます。  
  
1.  AG2 を Node3 にフェールオーバーする (Node2 を解放)。  
  
2.  Node2 をアップグレードまたは更新する。  
  
3.  AG1 を Node2 にフェールオーバーする (Node1 を解放)。  
  
4.  Node1 をアップグレードまたは更新する。  
  
5.  AG2 および AG3 を Node1 にフェールオーバーする (Node3 を解放)。  
  
6.  Node3 をアップグレードまたは更新する。  
  
7.  AG3 を Node3 にフェールオーバーする。  
  
 この順序でアップグレードを実行した場合、1 つの可用性グループに対して 2 回のフェールオーバーを実行するよりも平均ダウンタイムが小さくなります。 実行後の構成は、次の表のようになります。  
  
|可用性グループ|Node1|Node2|Node3|  
|------------------------|-----------|-----------|-----------|  
|AG1||プライマリ||  
|AG2|プライマリ|||  
|AG3|||プライマリ|  
  
 実際の実装方法に応じて、アップグレードの手順が変わる可能性があります。また、クライアント アプリケーションで発生するダウンタイムも変わります。  
  
> [!NOTE]  
>  多くの場合は、ローリング アップグレードが完了すると、元のプライマリ レプリカにフェールバックします。  
  
## 参照  
 [インストール ウィザードを使用した SQL Server 2016 へのアップグレード &#40;セットアップ&#41;](../../../database-engine/install-windows/upgrade-to-sql-server-2016-using-the-installation-wizard-setup.md)   
 [コマンド プロンプトからの SQL Server 2016 のインストール](../../../database-engine/install-windows/install-sql-server-2016-from-the-command-prompt.md)  
  
  