## <a name="managing-synchronous-commit-mode"></a>同期コミット モードの管理

>[!WARNING]
>場合によっては、Linux 上での同期コミット モードの SQL Server 可用性グループは、データ消失に対して脆弱になる可能性があります。 根本原因とデータ消失の回避策については、以下の詳細情報をご覧ください。 この問題は、今後のリリースで修正される予定です。

###<a name="pacemaker-notification-for-availability-group-resource-promotion"></a>可用性グループ リソース プロモーションの Pacemaker 通知

CTP 1.4 より前のリリースでは、可用性グループの Pacemaker リソース エージェントで、`SYNCHRONOUS_COMMIT` としてマークされたレプリカが本当に最新の状態であるかどうかを確認することができませんでした。 レプリカがプライマリとの同期を停止していても、それを認識していない可能性がありました。 そのため、エージェントがプライマリよりも古いレプリカを昇格させる可能性があり、成功した場合にはデータの損失が発生していました。 

SQL Server 2017 CTP 1.4 を追加`sequence_number`に`sys.availability_groups`この問題を解決するためにします。 `sequence_number` は、ローカルの可用性グループ レプリカがシステムの他の部分に対して最新であるかどうかを表す、単調増加 BIGINT です。 この数値は、フェールオーバー、レプリカの追加/削除、およびその他の可用性グループ操作を実行すると更新されます。 この数はプライマリ上で更新され、セカンダリにプッシュされます。 そのため、最新のセカンダリでは、この数がプライマリと同じになります。

Pacemaker は、レプリカをプライマリに昇格することを決定したら、まずすべてのレプリカに通知を送り、シーケンス番号を抽出して、それを格納します。 次に、Pacemaker が実際にレプリカをプライマリに昇格しようとする際、レプリカは、そのシーケンス番号がすべてのシーケンス番号の最大値である場合にのみ自身を昇格させ、それ以外の場合は昇格操作を拒否します。 この方法により、最大のシーケンス番号を持つレプリカだけがプライマリに昇格できるようになるため、データの損失が回避されます。

ただしこれは、昇格の対象となるレプリカのうち少なくとも 1 つが、以前のプライマリと同じシーケンス番号を持っている場合にのみ保証されます。 リソース エージェントでは Pacemaker からすべてのレプリカに通知を送る必要があるため、可用性リソースは `notify=true` を使用して設定する必要があります。 既存のすべての `ocf:mssql:ag` リソースについて、ユーザーは `mssql-server-ha` パッケージを CTP 1.4 に更新する前に、リソース構成を `notify=true` で更新する必要があります。そうしないと 、リソースがエラー状態になります。 

### <a name="how-to-avoid-potential-for-data-loss"></a>データ消失の可能性を回避する方法 

次の場合、データ消失に対する可用性グループの脆弱性は解消されない可能性があります。 5 つのノードを含むクラスターで、3 つの SQL Server インスタンス上にレプリカを持つ可用性グループがある場合は、プライマリ レプリカと 1 つのセカンダリ レプリカが、その他のセカンダリ レプリカを上回ること可能性があります。 そうなった場合、`sys.availability_groups` 内の `sequence_number` は他のレプリカよりも高くなります。 この状態で、2 つのレプリカがクラスターのその他の部分との接続を失った場合、Pacemaker は残りの 3 つのノードをクォーラムと見なし、潜在的なレプリカがプライマリに昇格するのを許可する可能性があります。 この状況においては、データ消失の可能性が生じます。

sql2017 数が、プライマリ上ですべてのトランザクションをコミットできる前に使用できるセカンダリを強制的に新しい機能が導入されています。 `REQUIRED_COPIES_TO_COMMIT` を使用すると、トランザクションを続行する前に、セカンダリ レプリカ データベースのトランザクション ログにコミットする必要があるレプリカの数を設定できます。 このオプションは、`CREATE AVAILABILITY GROUP` または `ALTER AVAILABILITY GROUP` で使用できます。 「[CREATE AVAILABILITY GROUP](http://msdn.microsoft.com/library/ff878399.aspx)」(可用性グループの作成) をご覧ください。

ここで説明したデータ消失の可能性を回避するには、`REQUIRED_COPIES_TO_COMMIT` を、同期されるレプリカの最大数に設定します。 今後のリリースでは、`REQUIRED_COPIES_TO_COMMIT` を自動的に設定するための組み込みロジックが導入される予定です。
`REQUIRED_COPIES_TO_COMMIT` が設定されている場合、プライマリ レプリカ データベースのトランザクションは、必要な数の同期セカンダリ レプリカのデータベース トランザクション ログでトランザクションがコミットされるまで待機します。 十分な数の同期セカンダリ レプリカがオンラインになっていない場合は、十分な数のセカンダリ レプリカとの通信が再開されるまで、トランザクションは停止します。

次の例では、可用性グループ名 [ag1] を `REQUIRED_COPIES_TO_COMMIT = 2` に設定しています。 

```Transact-SQL
ALTER AVAILABILITY GROUP [ag1]
SET (REQUIRED_COPIES_TO_COMMIT = 2)
```

上記の例では、可用性グループに 2 つのセカンダリ レプリカがある場合、両方のセカンダリ レプリカがコミットを確認するまで、操作が待機されます。 一方が応答していない場合、トランザクションはブロックされます。
