## <a name="pacemakerNotify"></a>Pacemaker 用の SQL Server リソース エージェントについて理解する

CTP 1.4 より前のリリースでは、可用性グループの Pacemaker リソース エージェントで、`SYNCHRONOUS_COMMIT` としてマークされたレプリカが本当に最新の状態であるかどうかを確認することができませんでした。 レプリカがプライマリとの同期を停止していても、それを認識していない可能性がありました。 そのため、エージェントが古いレプリカをプライマリに昇格させる可能性があり、成功した場合にはデータの損失が発生していました。 

SQL Server 2017 CTP 1.4 では、この問題を解決するために、`sys.availability_groups` に `sequence_number` が追加されました。 `sequence_number` は、ローカルの可用性グループ レプリカが可用性グループの残りのレプリカに対してどの程度最新であるかを表す、単調増加 BIGINT です。 この数値は、フェールオーバー、レプリカの追加または削除、およびその他の可用性グループ操作を実行すると更新されます。 この数はプライマリ上で更新され、セカンダリ レプリカにプッシュされます。 そのため、最新のセカンダリ レプリカでは、プライマリと同じシーケンス番号になります。 

Pacemaker は、レプリカをプライマリに昇格することを決定したら、まずすべてのレプリカに通知を送り、シーケンス番号を抽出して、それを格納します (これを昇格前通知と呼びます)。 次に、Pacemaker が実際にレプリカをプライマリに昇格しようとする際、レプリカは、そのシーケンス番号がすべてのレプリカのすべてのシーケンス番号の最大値である場合にのみ自身を昇格させ、それ以外の場合は昇格操作を拒否します。 この方法により、最大のシーケンス番号を持つレプリカだけがプライマリに昇格できるようになるため、データの損失が回避されます。 

ただしこれは、昇格の対象となるレプリカのうち少なくとも 1 つが、以前のプライマリと同じシーケンス番号を持っている場合にのみ保証されます。 これを保証するため、Pacemaker リソース エージェントの既定の動作では、少なくとも 1 つの同期コミット セカンダリ レプリカが最新の状態であり、自動フェールオーバーのターゲットとして使用できるように、`REQUIRED_COPIES_TO_COMMIT` が自動的に設定されます。 各監視アクションでは、`REQUIRED_COPIES_TO_COMMIT` の値が (’同期コミット レプリカの数’ / 2) と計算 (および、必要に応じて更新) されます。 その後、フェールオーバー時、リソース エージェントは (`total number of replicas` - `required_copies_to_commit` 個のレプリカ) に昇格前通知への応答を要求し、そのうちの 1 つをプライマリに昇格できるようにします。 最高の `sequence_number` を持つレプリカがプライマリに昇格されます。 

たとえば、3 つの同期レプリカ (1 つのプライマリ レプリカと 2 つの同期コミット セカンダリ レプリカ) を含む可用性グループの場合について考えます。

- `REQUIRED_COPIES_TO_COMMIT` は 3 / 2 = 1 です。

- 昇格前アクションに応答しなければならないレプリカの数は、3 - 1 = 2 です。 したがって、フェールオーバーがトリガーされるためには、2 個のレプリカが稼働している必要があります。 つまり、プライマリの停止時に、セカンダリ レプリカの 1 つが応答せず、1 つのセカンダリのみが昇格前アクションに応答する場合、リソース エージェントは、応答したセカンダリが最高のシーケンス番号を持つという保証が得られず、フェールオーバーはトリガーされません。

ユーザーは、既定の動作をオーバーライドし、可用性グループ リソースが上記のように `REQUIRED_COPIES_TO_COMMIT` を自動的に設定しないように構成できます。

>[!IMPORTANT]
>`REQUIRED_COPIES_TO_COMMIT` が 0 の場合、データ損失のリスクがあります。 プライマリが停止した場合、リソース エージェントは自動的にフェールオーバーをトリガーしません。 ユーザーは、プライマリが復旧するまで待つか、または手動でフェールオーバーするかを、決定する必要があります。

`REQUIRED_COPIES_TO_COMMIT` を 0 に設定するには、次のコマンドを実行します。

```bash
sudo pcs resource update <**ag_cluster**> required_copies_to_commit=0
```

(SLES での) crm の使用と同等のコマンドを、次に示します。

```bash
sudo crm resource param <**ag_cluster**> set required_synchronized_secondaries_to_commit 0
```

既定の計算値に戻すには、次のコマンドを実行します。

```bash
sudo pcs resource update <**ag_cluster**> required_copies_to_commit=
```

>[!NOTE]
>リソースのプロパティを更新すると、すべてのレプリカが停止して再起動します。 つまり、プライマリは一時的にセカンダリに降格された後で再び昇格されるので、一時的に書き込みができなくなります。 REQUIRED_COPIES_TO_COMMIT の新しい値はレプリカが再開した後でのみ設定されるので、pcs コマンドの実行に伴いすぐには設定されません。

## <a name="balancing-high-availability-and-data-protection"></a>高可用性とデータ保護のバランス 

上の既定の動作は、2 つの同期レプリカ (プライマリとセカンダリ) の場合にも適用されます。 Pacemaker は既定で `REQUIRED_COPIES_TO_COMMIT = 1` を設定し、データが最大限保護されるようにセカンダリ レプリカを常に最新の状態にします。  

>[!WARNING]
>このようにすると、セカンダリの計画的または非計画的な停止のために、プライマリ レプリカが使用できなくなるリスクが高くなります。 ユーザーは、リソース エージェントの既定の動作を変更し、`REQUIRED_COPIES_TO_COMMIT` を 0 にオーバーライドできます。

```bash
sudo pcs resource update <**ag1**> required_copies_to_commit=0
```

オーバーライドすると、リソース エージェントは `REQUIRED_COPIES_TO_COMMIT` の新しい設定を使うようになり、計算を停止します。 つまり、ユーザーは手動で更新する必要があります (たとえば、レプリカの数を増やす場合)。

次の表では、異なる可用性グループ リソース構成でのプライマリまたはセカンダリ レプリカの停止によって生じる結果について説明します。

### <a name="availability-group---2-sync-replicas"></a>可用性グループ - 2 つの同期レプリカ

| |プライマリ停止 |1 つのセカンダリ レプリカ停止
|:---|:--- |:--- |
|`REQUIRED_COPIES_TO_COMMIT=0`|ユーザーが手動で FAILOVER を発効する必要があります。 <br>データが失われる可能性があります。<br> 新しいプライマリは読み取り/書き込みです |プライマリは読み取り/書き込みであり、データが失われる可能性があります
|`REQUIRED_COPIES_TO_COMMIT=1` * |クラスターが FAILOVER を自動的に発行します <br>データの損失はありません。 <br> 前のプライマリが復旧してセカンダリとして可用性グループに参加するまで、新しいプライマリはすべての接続を拒否します。 |セカンダリが復旧するまで、プライマリはすべての接続を拒否します。

\* Pacemaker 用 SQL Server リソース エージェントの既定の動作。

### <a name="availability-group---3-sync-replicas"></a>可用性グループ - 3 つの同期レプリカ

| |プライマリ停止 |1 つのセカンダリ レプリカ停止
|:---|:--- |:--- |
|`REQUIRED_COPIES_TO_COMMIT=0`|ユーザーが手動で FAILOVER を発効する必要があります。 <br>データが失われる可能性があります。 <br>新しいプライマリは読み取り/書き込みです |プライマリは読み取り/書き込みです
|`REQUIRED_COPIES_TO_COMMIT=1` * |クラスターが FAILOVER を自動的に発行します。 <br>データの損失はありません。 <br>新しいプライマリは読み取り/書き込みです |プライマリは読み取り/書き込みです 

\* Pacemaker 用 SQL Server リソース エージェントの既定の動作。