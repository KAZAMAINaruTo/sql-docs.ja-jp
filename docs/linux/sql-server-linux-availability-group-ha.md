---
title: SQL Server Always On 可用性グループ配置のパターン |Microsoft ドキュメント
ms.custom: sql-linux
ms.date: 10/16/2017
ms.prod: sql
ms.prod_service: database-engine
ms.service: ''
ms.component: ''
ms.reviewer: ''
ms.suite: sql
ms.technology: database-engine
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: edd75f68-dc62-4479-a596-57ce8ad632e5
caps.latest.revision: 34
author: MikeRayMSFT
ms.author: mikeray
manager: craigg
ms.workload: Inactive
ms.openlocfilehash: f94214f44e7edc95097f3d5c8774fd8e8421a935
ms.sourcegitcommit: a85a46312acf8b5a59a8a900310cf088369c4150
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/26/2018
---
# <a name="high-availability-and-data-protection-for-availability-group-configurations"></a>可用性グループの構成の高可用性とデータの保護

[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-linuxonly](../includes/appliesto-ss-xxxx-xxxx-xxx-md-linuxonly.md)]

この記事では、Linux サーバー上の SQL Server Always On 可用性グループのサポートされる展開構成を表示します。 可用性グループには、高可用性とデータ保護がサポートしています。 障害の自動検出、自動フェールオーバー、およびフェールオーバー後に透過的な再接続は、高可用性を実現します。 同期されたレプリカは、データ保護を提供します。 

Windows Server フェールオーバー クラスター (WSFC)、高可用性の一般的な構成を使って 2 つのレプリカを同期し、3 番目のサーバーまたはファイル共有クォーラムを提供します。 ファイル共有監視は、たとえば、可用性グループの構成で、同期の状態と、レプリカのロールを検証します。 この構成により、セカンダリ レプリカのフェールオーバー ターゲットがある最新のデータと可用性グループ構成の変更として選択します。 

WSFC では、可用性グループ レプリカと、ファイル共有のミラーリング監視サーバーの間でフェールオーバーの判別に構成メタデータを同期します。 可用性グループは、WSFC では、ときに、SQL Server インスタンスは、master データベースに構成メタデータを格納します。

たとえば、Linux クラスター上の可用性グループは`CLUSTER_TYPE = EXTERNAL`します。 WSFC フェールオーバーについて交渉することはありません。 ここでは、構成メタデータの管理し、SQL Server インスタンスで保持されます。 このクラスターに、ミラーリング監視サーバーではない、ため構成状態のメタデータを格納する 3 番目の SQL Server インスタンスが必要です。 次の 3 つすべての SQL Server インスタンスは、同時に、クラスターの分散メタデータ ストレージを提供します。 

クラスター マネージャーでは、可用性グループ内の SQL Server のインスタンスのクエリを実行でき、高可用性を維持するためにフェールオーバーを調整することができます。 Linux クラスターのペースは、クラスター管理者です。 

SQL Server 2017 CU 1 を持つ可用性グループの高可用性を有効に`CLUSTER_TYPE = EXTERNAL`の 2 つの同期レプリカに加えて、レプリカの構成のみです。 SQL Server Express エディションを含む SQL Server 2017 CU1 またはそれ以降のすべてのエディションで、構成のみのレプリカをホストできます。 レプリカの構成のみでは、master データベース内の可用性グループに関する構成情報を保持が、可用性グループ内のユーザー データベースが含まれていません。 

## <a name="how-the-configuration-affects-default-resource-settings"></a>既定のリソース設定の構成の影響

SQL Server 2017 が導入されています、`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`クラスター リソース設定します。 この設定は、指定したセカンダリ レプリカの書き込み数、プライマリ レプリカは、各トランザクションをコミットする前にログに記録するトランザクション データを保証します。 外部のクラスター マネージャーを使用する場合、この設定は高可用性とデータ保護の両方に影響します。 設定の既定値は、クラスター リソースの作成時に、アーキテクチャに依存します。 エージェント インストールすると、SQL Server リソースの`mssql-server-ha`-可用性グループのクラスター リソースを作成、クラスター マネージャーの可用性の検出し構成と設定をグループ化`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`それに応じて。 

リソースのエージェント パラメーターの構成でサポートされている場合`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`が高可用性とデータ保護を提供する値に設定します。 詳細については、次を参照してください。[ペースの SQL Server の理解リソース エージェント](#pacemakerNotify)です。

次のセクションでは、クラスター リソースの既定の動作を説明します。 

高可用性、データ保護、および読み取りのスケールの特定のビジネス要件に対応する可用性グループの設計を選択します。

次の構成は、可用性グループのデザイン パターンと、各パターンの機能について説明します。 これらの設計パターンを持つ可用性グループに適用`CLUSTER_TYPE = EXTERNAL`高可用性ソリューションにします。 

- **次の 3 つの同期レプリカ**
- **2 つの同期レプリカ**
- **2 つのレプリカを同期および構成の唯一の複製**

<a name="threeSynch"></a>

## <a name="three-synchronous-replicas"></a>次の 3 つの同期レプリカ

この構成は、次の 3 つの同期レプリカで構成されます。 既定では、高可用性とデータ保護を提供します。 読み取りスケールも提供します。

![3 つのレプリカ][3]

次の 3 つの同期レプリカがある可用性グループには、読み取りのスケール、高可用性、およびデータ保護を提供できます。 次の表では、可用性の動作について説明します。 

| |読み取りのスケール|高可用性 (& a) </br> データの保護 | データの保護
|:---|---|---|---
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 |1<sup>*</sup>|2
|プライマリ停止 | 手動フェールオーバー。 データが失われる可能性があります。 新しいプライマリが R が付けられます。 |自動フェールオーバー。 新しいプライマリが R が付けられます。 |自動フェールオーバー。 前のプライマリが復旧し、セカンダリとして可用性グループに参加するまでは、新しいプライマリをユーザー トランザクションで使用できません。 
|1 つのセカンダリ レプリカ停止  | プライマリが R 付けられます。 プライマリが失敗した場合はない自動フェールオーバー。 |プライマリが R 付けられます。 プライマリにも失敗した場合はない自動フェールオーバー。 | プライマリでは、ユーザー トランザクションで使用できません。 
<sup>*</sup> 既定値

<a name="twoSynch"></a>

## <a name="two-synchronous-replicas"></a>2 つの同期レプリカ

この構成は、データの保護を実現します。 他の可用性グループ構成のように読み取りのスケールを有効にできます。 2 つの同期レプリカの構成は、自動の高可用性を提供しません。 

![2 つの同期レプリカ][1]

2 つの同期レプリカがある可用性グループは、読み取りのスケールとデータ保護を提供します。 次の表では、可用性の動作について説明します。 

| |読み取りのスケール |データの保護
|:---|---|---
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>*</sup>|1
|プライマリ停止 | 手動フェールオーバー。 データが失われる可能性があります。 新しいプライマリが R が付けられます。| 自動フェールオーバー。 前のプライマリが復旧し、セカンダリとして可用性グループに参加するまでは、新しいプライマリをユーザー トランザクションで使用できません。
|1 つのセカンダリ レプリカ停止  |読み取り/書き込み、データの損失を不安定な実行は、プライマリのです。 |プライマリはセカンダリあって回復するまではユーザー トランザクションで使用できません。
<sup>*</sup> 既定値

>[!NOTE]
>上記のシナリオでは、SQL Server 2017 CU 1 より前の動作です。 

<a name = "configOnly"></a>

## <a name="two-synchronous-replicas-and-a-configuration-only-replica"></a>2 つのレプリカを同期および構成の唯一の複製

2 つ (以上) の同期レプリカと構成のレプリカにのみ可用性グループは、データ保護を提供し、高可用性も提供します。 次の図は、このアーキテクチャを表します。

![可用性グループの唯一の構成][2]

1. セカンダリ レプリカへのユーザー データの同期レプリケーション。 可用性グループ構成のメタデータも含まれています。
2. 可用性グループ構成のメタデータの同期レプリケーション。 ユーザー データは含まれません。

可用性グループのダイアグラムでは、プライマリ レプリカはセカンダリ レプリカと構成の唯一のレプリカの両方に構成データをプッシュします。 セカンダリ レプリカでは、ユーザー データも受信します。 レプリカの構成のみが、ユーザー データを受信していません。 セカンダリ レプリカは同期の可用性モードです。 レプリカの構成のみでは、可用性グループ - 可用性グループに関するメタデータのみのデータベースは含まれません。 レプリカの構成のみで構成データは同期的にコミットされます。

>[!NOTE]
>構成のみのレプリカと、availabilility グループは、SQL Server 2017 CU1 を新しいです。 可用性グループ内の SQL Server のすべてのインスタンスは、SQL Server 2017 CU1 をする必要がありますまたはそれ以降。 

既定値`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`は 0 です。 次の表では、可用性の動作について説明します。 

| |高可用性 (& a) </br> データの保護 | データの保護
|:---|---|---
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>*</sup>|1
|プライマリ停止 | 自動フェールオーバー。 新しいプライマリが R が付けられます。 | 自動フェールオーバー。 新しいプライマリでは、ユーザー トランザクションで使用できません。 
|セカンダリ レプリカの停止 | プライマリ ファイル グループは読み取り/書き込みを実行して公開されているデータの損失を (プライマリが失敗し、回復することはできません) です。 プライマリにも失敗した場合はない自動フェールオーバー。 | プライマリでは、ユーザー トランザクションで使用できません。 プライマリにも失敗した場合にフェールオーバーするレプリカがありません。 
|構成のみのレプリカの停止 | プライマリが R 付けられます。 プライマリにも失敗した場合はない自動フェールオーバー。 | プライマリが R 付けられます。 プライマリにも失敗した場合はない自動フェールオーバー。 
|同期セカンダリ + の構成のみのレプリカの停止| プライマリでは、ユーザー トランザクションで使用できません。 自動フェールオーバーはありません。 | プライマリでは、ユーザー トランザクションで使用できません。 レプリカにフェールオーバーする場合はプライマリでも失敗しません。 
<sup>*</sup> 既定値

>[!NOTE]
>構成のみのレプリカをホストする SQL Server のインスタンスは、他のデータベースをホストすることもできます。 1 つ以上の可用性グループの構成のみデータベースとして参加できます。 

## <a name="requirements"></a>必要条件

* 構成の唯一のレプリカを可用性グループ内のすべてのレプリカは、SQL Server 2017 CU 1 またはそれ以降である必要があります。
* SQL Server の任意のエディションでは、SQL Server Express を含む、構成のみレプリカをホストできます。 
* 可用性グループには、プライマリ レプリカに加えて - には、少なくとも 1 つのセカンダリ レプリカが必要があります。
* 構成の唯一のレプリカは、SQL Server のインスタンスごとのレプリカの最大数になるまではカウントされません。 SQL Server の standard エディションで許容される最大 3 つのレプリカが、SQL Server Enterprise Edition には最大 9 ができます。

## <a name="considerations"></a>考慮事項

* 可用性グループにつき 2 つ以上の構成のみのレプリカです。 
* 構成の唯一のレプリカは、プライマリ レプリカにすることはできません。
* 構成の唯一のレプリカの可用性モードを変更することはできません。 同期または非同期のセカンダリ レプリカの構成のみのレプリカから変更するには、構成のみのレプリカを削除し、必要な可用性モードのセカンダリ レプリカを追加します。 
* 構成の唯一のレプリカの可用性グループ メタデータと同期しています。 ユーザー データがありません。 
* 1 つのプライマリ レプリカと 1 つの構成のみのレプリカがないセカンダリ レプリカを可用性グループが正しくありません。 
* SQL Server Express edition のインスタンスに可用性グループを作成できません。 

<a name="pacemakerNotify"></a>

## <a name="understand-sql-server-resource-agent-for-pacemaker"></a>ペースに対する SQL Server エージェントのリソースを理解します。

SQL Server 2017 CTP 1.4 追加`sequence_number`に`sys.availability_groups`レプリカがプライマリ レプリカとが最新であるかのセカンダリを識別するペースを許可します。 `sequence_number` 最新であるか、ローカルの可用性グループのレプリカを表す単調に増加する bigint 型の値です。 ペースの更新プログラム、`sequence_number`可用性グループの構成変更のたびにします。 構成の変更には、フェールオーバー、レプリカの追加または削除などがあります。 数が、プライマリ上で更新し、セカンダリ レプリカにレプリケートします。 このため、最新の状態の構成を持つセカンダリ レプリカは、プライマリと同じシーケンス番号です。 

最初は送信をプライマリ レプリカを昇格するペースが決定したら、*事前昇格*すべてのレプリカに通知します。 レプリカは、シーケンス番号を返します。 次に、ペースが実際には、レプリカはプライマリに昇格しようとするとき、レプリカのみ昇格自体のシーケンス番号が、すべてのシーケンス番号の最も高い場合。 独自のシーケンス番号が一番大きいシーケンス番号が一致しない場合、レプリカは、昇格操作を拒否します。 この方法により、最大のシーケンス番号を持つレプリカだけがプライマリに昇格できるようになるため、データの損失が回避されます。 

このプロセスでは、以前のプライマリと同じシーケンス番号を持つプロモーションの利用可能な少なくとも 1 つのレプリカが必要です。 ペース リソース エージェント セットを使用すると、`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`になるようには、少なくとも 1 つの同期セカンダリ レプリカは最新であり、既定では、自動フェールオーバーのターゲットに使用できます。 各監視のアクションの値に`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`計算 (および必要に応じて更新) します。 `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`値は 2 で 'の同期レプリカの数' 割った値します。 フェールオーバー時に、リソースのエージェントが必要です (`total number of replicas`  -  `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`レプリカ) に応答する、事前の通知を昇格します。 最高の値を持つレプリカ`sequence_number`がプライマリに昇格します。 

たとえば、次の 3 つの同期レプリカの 1 つのプライマリ レプリカと 2 つの同期セカンダリ レプリカを可用性グループです。

- `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` 1 になります。(3 -> 1 の 2/)。

- 事前昇格アクションに応答するレプリカの必要な数は 2 です。(3-1 = 2)。 

このシナリオでは、2 つのレプリカは、フェールオーバーをトリガーする応答する必要です。 最新の状態にして、応答、プライマリ レプリカの停止後に自動フェールオーバーを正常に実行、両方のセカンダリ レプリカが必要な事前の通知を昇格します。 Online と同期する場合は、同じシーケンス番号があります。 可用性グループを使用して、それらの 1 つ昇格させます。 応答するセカンダリ レプリカの 1 つだけの場合、事前昇格アクション、リソース エージェントは、応答したセカンダリが最高の sequence_number され、フェールオーバーがトリガーされないことを保証ことはできません。

>[!IMPORTANT]
>`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` が 0 の場合、データ損失のリスクがあります。 プライマリ レプリカの停止中に、リソースのエージェントに自動的にフェールオーバーは発生しません、します。 プライマリへの回復を待つか、手動フェールオーバーを使用することができます`FORCE_FAILOVER_ALLOW_DATA_LOSS`です。

既定の動作をオーバーライドして、可用性グループ リソースも設定することもできます`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`自動的にします。

次のスクリプト セット`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`という名前の可用性グループに対して、0 に`<**ag1**>`です。 実行する前に、`<**ag1**>` を実際の可用性グループの名前に置き換えます。

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=0
```

可用性グループ構成の実行に基づいて、既定値に戻すには。

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=
```

>[!NOTE]
>上記のコマンドを実行すると、プライマリが一時的に降格セカンダリ、し、もう一度昇格されます。 リソースの更新では、すべてのレプリカを停止し、再起動が発生します。 新しい値`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`、瞬時にないレプリカが再起動したら、のみ設定します。

## <a name="see-also"></a>参照

[Linux 上の可用性グループ](sql-server-linux-availability-group-overview.md)

<!--Image references-->
[1]: ./media/sql-server-linux-availability-group-ha/1-read-scale-out.png
[2]: ./media/sql-server-linux-availability-group-ha/2-configuration-only.png
[3]: ./media/sql-server-linux-availability-group-ha/3-three-replica.png
[4]: ./media/sql-server-linux-availability-group-ha/configuration-only-example.png
