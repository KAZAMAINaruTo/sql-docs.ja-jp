---
title: "列ストア インデックス データの読み込み | Microsoft Docs"
ms.custom: 
  - "SQL2016_New_Updated"
ms.date: "01/27/2017"
ms.prod: "sql-server-2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "database-engine"
ms.tgt_pltfrm: ""
ms.topic: "article"
ms.assetid: b29850b5-5530-498d-8298-c4d4a741cdaf
caps.latest.revision: 31
author: "barbkess"
ms.author: "barbkess"
manager: "jhubbard"
caps.handback.revision: 28
---
# 列ストア インデックス データの読み込み
[!INCLUDE[tsql-appliesto-ss2012-all_md](../../includes/tsql-appliesto-ss2012-all-md.md)]

  標準的な SQL 一括読み込みとトリクル挿入メソッドを使用して、列ストア インデックスにデータを読み込みます。 これらのメソッドには、bcp、統合サービス、および Transact-SQL の merge または insert ステートメントが含まれます。  
  
 列ストア インデックスを初めて使用する場合は、 「[列ストア インデックス ガイド](../Topic/Columnstore%20Indexes%20Guide.md)」で用語および概念について確認してください。  
  
 詳しい説明が必要な場合は、 この [ブログ投稿](http://blogs.msdn.com/b/sqlcat/archive/2015/03/11/data-loading-performance-considerations-on-tables-with-clustered-columnstore-index.aspx)を参照してください。  
  
##  <a name="dataload_cci"></a> クラスター化列ストア インデックスへの一括読み込み  
 クラスター化列ストア インデックスに行を一括で読み込む場合は、bcp コマンド ライン ツール、Integration Services を使用するか、ステージング テーブルから行を選択することができます。  
  
 ![クラスター化列ストア インデックスへの読み込み](../../relational-databases/indexes/media/sql-server-pdw-columnstore-loadprocess.gif "クラスター化列ストア インデックスへの読み込み")  
  
 上記の図に示すように、一括読み込みでは、  
  
1.  データは事前に並べ替えられません。 データは受信順に行グループに挿入されます。  
  
2.  バッチ サイズが 102400 以上の場合、行は圧縮された行グループに直接移動されます。 効率的に一括でインポートするために 102400 以上のバッチ サイズを選択することをお勧めします。バックグラウンド スレッドの組ムーバー (TM) により圧縮された行グループに最終的に行が移動される前に、データ行がデルタ行グループに移動されないようにすることができるためです。  
  
3.  バッチ サイズが 102400 未満の場合、または残りの行が 102400 未満の場合、行はデルタ行グループに読み込まれます。  
  
 クラスター化列ストア インデックスへの一括読み込みで使用可能な最適化を以下に示します。  
  
-   並列読み込み: それぞれ別のデータ ファイルを読み込む、複数の同時一括インポート (bcp または一括インポート) を同時に行うことができます。 行ストアとは異なり、各一括インポート スレッドでは排他的ロックを使用して排他的にデータを別の行グループに読み込むため、TABLOCK を指定する必要はありません。   TABLOCK を使用すると、テーブルで排他的ロックが適用され、データを並列でインポートすることはできません。  
  
-   ログの最適化: データが圧縮された行グループに読み込まれる場合、一括読み込みのログへの記録を最小限に抑えます。 バッチ サイズが 102400 未満のデルタ行グループにデータが読み込まれる場合、最小ログ記録は行われません。  
  
-   ロックの最適化: 圧縮された行グループに読み込む場合は、行グループに対する X ロックが獲得されます。 ただし、デルタ行グループへの一括読み込みの場合、X ロックは行グループで獲得されますが、X 行グループ ロックはロック階層の一部ではないため、SQL Server は引き続き PAGE/EXTENT のロックを行います。  
  
 非クラスター化インデックスがある場合、インデックス自体のロックやログの最適化は行われませんが、前述のとおり、クラスター化列ストア インデックスの最適化は引き続き行われます。  
  
## デルタストアのしくみ  
 クラスター化列ストア インデックスではデルタストアで最大 1,048,576 個の列を収集してから、圧縮された列グループに圧縮します。 これにより、列ストア インデックスの圧縮が向上します。 デルタストア行グループに 1,048,576 個の行が含まれている場合、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] は列グループが閉じられたと見なします。 *組ムーバー*というバックグラウンド プロセスでは、閉じられた行グループを見つけて、それを列ストアに圧縮します。  
  
 各クラスター化 columnstore インデックスに対して複数のデルタストアが許容されます。  
  
-   デルタストアがロックされている場合、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] は別のデルタストアのロックを獲得しようとします。 使用できるデルタストアがない場合、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] は新しいデルタストアを作成します。  
  
-   パーティション テーブルの場合、各パーティションに複数のデルタストアを使用できます。  
  
 次のシナリオでは、読み込まれた行が列ストアに直接移動する場合やデルタストアに移動する場合について説明します。  
  
 この例では、行グループはそれぞれ 102,400 ～ 1,048,576 個の行を持つことができます。 実際には、行グループの最大サイズは、メモリが不足している場合、1,048,576 行より小さくなることがあります。  
  
|一括読み込みを行う行|圧縮された行グループに追加される行|デルタ行グループに追加される行|  
|-----------------------|-------------------------------------------|--------------------------------------|  
|102,000|0|102,000|  
|145,000|145,000<br /><br /> 行グループのサイズ: 145,000|0|  
|1,048,577|1,048,576<br /><br /> 行グループのサイズ: 1,048,576|1|  
|2,252,152|2,252,152<br /><br /> 行グループのサイズ: 1,048,576、1,048,576、155,000|0|  
  
 次の例は、1,048,577 個の行をテーブルに読み込んだ結果を示しています。 この結果では、列ストアに 1 つの圧縮された行グループ (圧縮された列セグメントとして)、およびデルタストアに 1 行があります。  
  
```  
SELECT object_id, index_id, partition_number, row_group_id, delta_store_hobt_id, state state_desc, total_rows, deleted_rows, size_in_bytes   
FROM sys.dm_db_column_store_row_group_physical_stats  
```  
  
 ![Rowgroup and deltastore for a batch load](../../relational-databases/indexes/media/sql-server-pdw-columnstore-batchload.gif "Rowgroup and deltastore for a batch load")  
  
## ステージング テーブルからの読み込み  
 データの読み込みの一般的なパターンでは、ステージング テーブルにデータを読み込み、変換を行ってから、以下のコマンドを使用してターゲット テーブルに読み込みます。  
  
```  
INSERT INTO <columnstore index>  SELECT <list of columns> FROM <Staging Table>  
  
```  
  
 このコマンドでは、BCP や一括挿入と同じように列ストア インデックスにデータを読み込みますが、データは単一のバッチにまとめられます。 ステージング テーブルの行数が 102400 未満の場合、行はデルタ行グループに読み込まれ、それ以外の場合、行は圧縮された列グループに直接読み込まれます。  この INSERT 操作はシングル スレッドの場合に限られていました。 データの並列読み込みを行う場合、複数のステージング テーブルを作成するか、ステージング テーブルの重複していない行の範囲を指定して INSERT/SELECT を実行することができます。  このような制限は SQL Server 2016 にはありません。 次のコマンドではステージング テーブルからデータを並列で読み込みますが、TABLOCK を指定する必要があります。  
  
```  
INSERT INTO <columnstore index>  WITH (TABLOCK)  SELECT <list of columns> FROM <Staging Table>  
```  
  
 ステージング テーブルからクラスター化列ストア インデックスへの一括読み込みで使用可能な最適化を以下に示します。  
  
-   ログの最適化: データが圧縮された行グループに読み込まれる場合は、最小ログ記録が行われます。 デルタ行グループにデータが読み込まれる場合、最小ログ記録は行われません。  
  
-   ロックの最適化: 圧縮された行グループに読み込む場合は、行グループに対する X ロックが獲得されます。 ただし、デルタ行グループでは、X ロックは行グループで獲得されますが、X 行グループ ロックはロック階層の一部ではないため、SQL Server は引き続き PAGE/EXTENT のロックを行います。  
  
 非クラスター化インデックスがある場合、インデックス自体のロックやログの最適化は行われませんが、前述のとおり、クラスター化列ストア インデックスの最適化は引き続き行われます。  
  
## トリクル挿入による読み込み  
 *トリクル挿入* とは、INSERT INTO を使用して列ストアに行を取り込む方法のことです。 各行はデルタ行グループに追加されます。 トリクルされる行はデルタストア行グループに直接移動します。その場合、行が 1,048,576 個に達して行グループが閉じられるまで、または列ストア インデックスが再構築されるまで、行は蓄積されます。  
  
```  
INSERT INTO <table-name> VALUES (<set of values>)  
```  
  
 クラスター化列ストア インデックスに値を挿入するために INSERT INTO を使用する並行スレッドでは、同じデルタストア行グループに行が挿入される場合があることに注意してください。  
  
 列グループに 1,048, 576 個の行が含まれると、デルタ行グループは閉じられたと見なされますが、クエリや更新/削除操作では引き続き使用できます。ただし、新しく挿入される行は既存のデルタストア列グループまたは新しく作成されたデルタストア列グループに移動します。 閉じられたデルタ行グループを 5 分程度ごとに定期的に圧縮する*組ムーバー (TM)* というバックグラウンド スレッドがあります。 閉じられたデルタ行グループを圧縮する場合、次のコマンドを明示的に呼び出すことができます。  
  
```  
ALTER INDEX <index-name> on <table-name> REORGANIZE  
```  
  
 デルタ行グループを強制的に閉じ、圧縮する場合は、以下のコマンドを実行できます。 行の読み込みが終了し、新しい行は必要ない場合、このコマンドを実行できます。 デルタ行グループを明示的に閉じ、圧縮することで、より多くのストレージを確保し、分析クエリのパフォーマンスを向上させることができます。 新しい行を挿入する必要がない場合は、このコマンドを呼び出すことをお勧めします。  
  
```  
ALTER INDEX <index-name> on <table-name> REORGANIZE with (COMPRESS_ALL_ROW_GROUPS = ON)  
```  
  
## パーティション テーブルへの読み込み  
 パーティション分割されたデータの場合、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] はまずパーティションに各行を割り当て、次にパーティション内のデータの columnstore 処理を実行します。 各パーティションには、独自の行グループと少なくとも 1 つのデルタストアがあります。  
  
## 非クラスター化列ストア インデックスへの読み込み  
 非クラスター化列ストア インデックス データを含む行ストア テーブルでは、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] は常にベース テーブルにデータを挿入します。 データが列ストア インデックスに直接挿入されることはありません。  
  
## 参照  
 [列ストア インデックス ガイド](../Topic/Columnstore%20Indexes%20Guide.md)   
 [列ストア インデックスのバージョン管理機能の概要](../Topic/Columnstore%20Indexes%20Versioned%20Feature%20Summary.md)   
 [列ストア インデックスのクエリ パフォーマンス](../../relational-databases/indexes/columnstore-indexes-query-performance.md)   
 [列ストアを使用したリアルタイム運用分析の概要](../../relational-databases/indexes/get-started-with-columnstore-for-real-time-operational-analytics.md)   
 [データ ウェアハウスの列ストア インデックス](../Topic/Columnstore%20Indexes%20for%20Data%20Warehousing.md)   
 [列ストア インデックスの最適化](../../relational-databases/indexes/columnstore-indexes-defragmentation.md)  
  
  