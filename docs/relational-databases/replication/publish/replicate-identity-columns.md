---
title: "ID 列のレプリケート | Microsoft Docs"
ms.custom: ""
ms.date: "10/04/2016"
ms.prod: "sql-server-2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "replication"
ms.tgt_pltfrm: ""
ms.topic: "article"
helpviewer_keywords: 
  - "ID [SQL Server レプリケーション]"
  - "ID 値 [SQL Server レプリケーション]"
  - "マージ レプリケーション [SQL Server レプリケーション], ID 範囲の管理"
  - "パブリッシング [SQL Server レプリケーション], ID 列"
  - "トランザクション レプリケーション, ID 範囲の管理"
  - "ID 列 [SQL Server], レプリケーション"
ms.assetid: eb2f23a8-7ec2-48af-9361-0e3cb87ebaf7
caps.latest.revision: 51
author: "BYHAM"
ms.author: "rickbyh"
manager: "jhubbard"
caps.handback.revision: 51
---
# ID 列のレプリケート
  IDENTITY プロパティを列に割り当てると [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] id 列を含むテーブルに挿入される新しい行に対して連続する番号が自動的に生成されます。 詳細については、次を参照してください。 [ID および #40 です。プロパティと #41 です。& #40 です。Transact SQL と #41;](../Topic/IDENTITY%20\(Property\)%20\(Transact-SQL\).md)します。 ID 列は主キーの一部に含まれる場合があるため、ID 列の値が重複しないようにすることが重要です。 複数のノードで更新されるレプリケーション トポロジで ID 列を使用するには、レプリケーション トポロジ内の各ノードで異なる範囲の ID 値を使用して、重複が生じないようにする必要があります。  
  
 たとえば、パブリッシャーに 1 ～ 100 の範囲を、サブスクライバー A に 101 ～ 200 の範囲を、サブスクライバー B に 201 ～ 300 の範囲を、それぞれ割り当てることができます。 パブリッシャーに行が挿入され、ID 値がたとえば 65 の場合、この値が各サブスクライバーにレプリケートされます。 レプリケーションによって各サブスクライバーにデータが挿入されると、サブスクライバー テーブル内の ID 列の値は増えずに、リテラル値 65 が挿入されます。 ID 列の値が増えるのは、ユーザーによる挿入のみで、レプリケーション エージェントの挿入では増えません。  
  
 レプリケーションではすべての種類のパブリケーションおよびサブスクリプションの ID 列が処理され、列は手動で管理することも、レプリケーションで自動で管理することもできます。  
  
> [!NOTE]  
>  パブリッシュされたテーブルに ID 列を追加することはサポートされていません。これは、列がサブスクライバーにレプリケートされると集約されなくなる可能性があるからです。 パブリッシャーの ID 列の値は、影響を受けるテーブルの行が物理的に格納されている順序に依存します。 サブスクライバーで行が同じように格納されているとは限らないため、同じ行で ID 列の値が異なる可能性があります。  
  
## ID 範囲の管理オプションの指定  
 レプリケーションには、次の 3 つの ID 範囲の管理オプションがあります。  
  
-   自動。 サブスクリプションでの更新を使用するマージ レプリケーションおよびトランザクション レプリケーションで使用されます。 パブリッシャーおよびサブスクライバーのサイズの範囲を指定し、レプリケーションによって新しい範囲の割り当てを自動的に管理します。 レプリケーションによって、サブスクライバーの ID 列に NOT FOR REPLICATION オプションが設定されるため、サブスクライバーではユーザーの挿入のみによって値が増えます。  
  
    > [!NOTE]  
    >  サブスクライバーは、パブリッシャーと同期して新しい範囲を受け取る必要があります。 サブスクライバーには ID の範囲が自動的に割り当てられるため、サブスクライバーが新しい範囲を繰り返し要求すると、サブスクライバーは ID 範囲をすべて使用してしまう可能性があります。  
  
-   手動。 サブスクライバーでの更新を使用しないスナップショット レプリケーションおよびトランザクション レプリケーション、ピア ツー ピア トランザクション レプリケーション、またはアプリケーションがプログラムを介して ID 範囲を管理する必要がある場合に使用されます。 手動による管理を指定した場合は、範囲をパブリッシャーおよび各サブスクライバーに割り当て、初期の範囲が使用された場合は新しい範囲を割り当てる必要があります。 レプリケーションによって、サブスクライバーの ID 列に NOT FOR REPLICATION オプションが設定されます。  
  
-   [なし] : このオプションは、[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] の以前のバージョンとの互換性が必要な場合のみ使用することをお勧めします。また、このオプションは、トランザクション パブリケーションのストアド プロシージャ インターフェイスからのみ使用できます。  
  
 Id 範囲管理オプションを指定するを参照してください。 [Id 列の管理](../../../relational-databases/replication/publish/manage-identity-columns.md)します。  
  
## ID 範囲の割り当て  
 マージ レプリケーションとトランザクション レプリケーションでは、範囲の割り当てにさまざまな方法を使用します。これらの方法についてこのセクションで説明します。  
  
 ID 列をレプリケートする場合は 2 種類の範囲を考慮する必要があります。1 つはパブリッシャーおよびサブスクライバーに割り当てる範囲で、もう 1 つは列のデータ型の範囲です。 以下の表に、ID 列で通常使用されるデータ型で利用可能な範囲を示します。 この範囲は、トポロジ内のすべてのノードで使用されます。 たとえば、 **smallint** 1 に値が 1 から開始して、挿入の最大数は 32,767 のパブリッシャーとすべてのサブスクライバー。 実際の挿入数は、使用する値にギャップがあるかどうか、およびしきい値が使用されているかどうかによって変わります。 しきい値の詳細については、「マージ レプリケーション」「キュー更新サブスクリプションを使用するトランザクション レプリケーション」のセクションを参照してください。  
  
 場合は、パブリッシャーでは、id 範囲を使い尽くした挿入後、それは自動的に割り当てる新しい範囲のメンバーによって、挿入が実行された場合、 **db_owner** 固定データベース ロール。 挿入がそのロール、ログ リーダー エージェント、マージ エージェント、またはメンバーとなっているユーザーではなくユーザーによって実行された場合の **db_owner** ロールを実行する必要があります [sp_adjustpublisheridentityrange & #40 です。Transact SQL と #41;](../../../relational-databases/system-stored-procedures/sp-adjustpublisheridentityrange-transact-sql.md)します。 トランザクション パブリケーションの場合は、ログ リーダー エージェントを実行して新しい範囲を自動で割り当てる必要があります (既定ではエージェントは継続して実行されます)。  
  
> [!WARNING]  
>  大規模な一括挿入中には、挿入の各行ではなく、レプリケーション トリガーが 1 回だけ発生します。 Id 範囲がなど、大規模な挿入時に消費された場合、insert ステートメントの失敗につながります、 **INSERT INTO** ステートメントです。  
  
|データ型|範囲|  
|---------------|-----------|  
|**tinyint**|自動管理ではサポートされません。|  
|**smallint**|-2^15 (-32,768) ～ 2^15-1 (32,767)|  
|**int**|-2^31 (-2,147,483,648) ～ 2^31-1 (2,147,483,647)|  
|**bigint**|-2^63 (-9,223,372,036,854,775,808) ～ 2^63-1 (9,223,372,036,854,775,807)|  
|**10 進** と **数値**|-10^38+1 ～ 10^38-1|  
  
> [!NOTE]  
>  複数のテーブルで使用できる自動的に増分する番号、またはテーブルを参照せずにアプリケーションから呼び出すことができる自動的に増分する番号を作成するには、「[シーケンス番号](../../../relational-databases/sequence-numbers/sequence-numbers.md)」を参照してください。  
  
### マージ レプリケーション  
 ID 範囲はパブリッシャーで管理されて、マージ エージェントによってサブスクライバーに反映されます (再パブリッシュ階層では、範囲はルートのパブリッシャーとリパブリッシャーで管理されます)。 ID 値はパブリッシャーのプールから割り当てられます。 パブリケーションの新規作成ウィザードでまたはを使用して、パブリケーションに id 列を持つアーティクルを追加すると [sp_addmergearticle & #40 です。Transact SQL と #41;](../../../relational-databases/system-stored-procedures/sp-addmergearticle-transact-sql.md), の値を指定します。  
  
-   **@Identity_range** クライアント サブスクリプションで最初に、パブリッシャーとサブスクライバーの両方に割り当てられる id 範囲のサイズを制御するパラメーターです。  
  
    > [!NOTE]  
    >  以前のバージョンを実行しているサブスクライバー [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], このパラメーター (ではなく、 **@pub_identity_range** パラメーター) も再パブリッシュ サブスクライバーで id 範囲のサイズを制御します。  
  
-    **@Pub_identity_range** パラメーターで、サーバー サブスクリプション (データを再パブリッシュするために必要な) を使用するサブスクライバーに割り当てる再パブリッシュの id 範囲のサイズを制御します。 サーバー サブスクリプションを使用するすべてのサブスクライバーは、実際にはデータを再パブリッシュしない場合でも、再パブリッシュ用の範囲を受け取ります。  
  
-    **@Threshold** id の新しい範囲がサブスクリプションの必要な場合を判断するために使用するパラメーター [!INCLUDE[ssEW](../../../includes/ssew-md.md)] または以前のバージョンの [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]です。  
  
 たとえば、10,000 を指定する **@identity_range** と 500,000 **@pub_identity_range**します。 パブリッシャーと実行しているすべてのサブスクライバー [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] サーバー サブスクリプションにサブスクライバーを含め、新しいバージョンにはプライマリ範囲として 10,000 が割り当てられています。 サーバー サブスクリプションにサブスクライバーに再パブリッシュ サブスクライバーと同期するサブスクライバーで使用できる 500,000 のプライマリ範囲が割り当てられます (も指定する必要があります **@identity_range**, 、**@pub_identity_range**, 、および **@threshold** 再パブリッシュ サブスクライバーでパブリケーションのアーティクルの)。  
  
 実行している各サブスクライバー [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] またはそれ以降のバージョンも、セカンダリ id 範囲を受信します。 セカンダリ範囲のサイズはプライマリ範囲のサイズと同じです。プライマリ範囲がすべて使用されると、セカンダリ範囲が使用されて、マージ エージェントによって新しい範囲がサブスクライバーに割り当てられます。 新しい範囲はセカンダリ範囲となり、サブスクライバーで ID 値が使用される限りこのプロセスは継続されます。  
  
  
### キュー更新サブスクリプションを使用するトランザクション レプリケーション  
 ID 範囲はディストリビューターで管理されて、ディストリビューション エージェントによってサブスクライバーに反映されます。 ID 値はディストリビューターのプールから割り当てられます。 プールのサイズは、データ型のサイズと、ID 列に対して使用される増分に基づいています。 パブリケーションの新規作成ウィザードでまたはを使用して、パブリケーションに id 列を持つアーティクルを追加すると [sp_addarticle & #40 です。Transact SQL と #41;](../../../relational-databases/system-stored-procedures/sp-addarticle-transact-sql.md), の値を指定します。  
  
-    **@Identity_range** パラメーターで、最初にすべてのサブスクライバーに割り当てられる id 範囲のサイズを制御します。  
  
-    **@Pub_identity_range** パラメーターで、パブリッシャーに割り当てられている id 範囲のサイズを制御します。  
  
-    **@Threshold** パラメーターは、id の新しい範囲は、サブスクリプションに必要な時間を判断するために使用します。  
  
 たとえば、10,000 を指定する **@pub_identity_range**, 、1000 **@identity_range** (サブスクライバーの更新の数が少ないと仮定)、80% の **@threshold**します。 サブスクライバーの挿入数が 800 (1,000 の 80%) を超えると、サブスクライバーに新しい範囲が割り当てられます。 パブリッシャーの挿入数が 8,000 を超えると、パブリッシャーに新しい範囲が割り当てられます。 新しい範囲が割り当てられると、テーブル内の ID 範囲値にはギャップが生じます。 高いしきい値を指定すると、ギャップは小さくなりますが、システムのフォールト トレランスは低くなります。ディストリビューション エージェントが何らかの理由で実行できない場合、サブスクライバーで ID の消費がさらに進みやすくなります。  
  
## 手動で ID 範囲を管理する場合の範囲の割り当て  
 手動による ID 範囲の管理を指定した場合は、パブリッシャーと各サブスクライバーがそれぞれ異なる ID 範囲を使用することが必要です。 たとえば、`IDENTITY(1,1)` と定義されている ID 列を含むパブリッシャーのテーブルがあるとします。ID 列は 1 から開始し、行が挿入されるたびに 1 ずつ増えていきます。 パブリッシャーのテーブルの行数が 5,000 で、アプリケーションを実行中にテーブルがある程度大きくなると考えられる場合、パブリッシャーでは範囲 1 ～ 10,000 を使用できます。 2 つのサブスクライバーの場合、サブスクライバー A では 10,001 ～ 20,000 を使用し、サブスクライバー B では 20,001 ～ 30,000 を使用できます。  
  
 サブスクライバーが、スナップショットまたは別の方法で初期化された後に、DBCC CHECKIDENT を実行してサブスクライバーに ID 範囲の開始位置を割り当てます。 たとえば、サブスクライバー A では、`DBCC CHECKIDENT('<TableName>','reseed',10001)` を実行します。 実行すると、サブスクライバー b で `CHECKIDENT('<TableName>','reseed',20001)`します。  
  
 新しい範囲をパブリッシャーまたはサブスクライバーに割り当てるには、DBCC CHECKIDENT を実行し、新しい値を指定してテーブルを再作成します。 新しい範囲を割り当てる必要がある時点を指定するには、いくつかの方法があります。 たとえば、ノードがその範囲をすべて使用しそうになったことを検出するメカニズムをアプリケーションに用意し、DBCC CHECKIDENT を使用して新しい範囲を割り当てることができます。 また、CHECK 制約を追加して、使用される範囲 ID 値が不足しそうになると行を追加できなくなるようにすることもできます。  
  
## データベース復元後の ID 範囲の処理  
 自動 ID 範囲の管理を使用している場合、サブスクライバーがバックアップから復元されたときに、新しい ID 値の範囲が自動的に要求されます。 パブリッシャーをバックアップから復元する場合は、パブリッシャーに適切な範囲を割り当てる必要があります。 マージ レプリケーションで使用して新しい範囲を割り当てる [sp_restoremergeidentityrange & #40 です。Transact SQL と #41;](../../../relational-databases/system-stored-procedures/sp-restoremergeidentityrange-transact-sql.md)します。 トランザクション レプリケーションの場合は、使用されている最も高い値を特定してから、新しい範囲の開始位置を設定します。 パブリケーション データベースが復元された後に次の手順を実行します。  
  
1.  すべてのサブスクライバーのすべての操作を停止します。  
  
2.  ID 列を含むパブリッシュされたテーブルごとに、以下を実行します。  
  
    1.  各サブスクライバーのサブスクリプション データベースで `IDENT_CURRENT('<TableName>')` を実行します。  
  
    2.  すべてのサブスクライバーで検出された最も高い値を記録します。  
  
    3.  パブリッシャーのパブリケーション データベースで、`DBCC CHECKIDENT(<TableName>','reseed',<HighestValueFound+1>`) を実行します。  
  
    4.  パブリッシャーのパブリケーション データベースでは、実行 `sp_adjustpublisheridentityrange <PublicationName>, <TableName>`します。  
  
    > [!NOTE]  
    >  ID 列の値が増分ではなく減分に設定されている場合は、検出された最も低い値を記録してから、その値から新しい範囲を設定します。  
  
## 参照  
 [BACKUP &#40;Transact-SQL&#41;](../../../t-sql/statements/backup-transact-sql.md)   
 [DBCC CHECKIDENT & #40 です。Transact SQL と #41 です。](../../../t-sql/database-console-commands/dbcc-checkident-transact-sql.md)   
 [IDENT_CURRENT と #40 です。Transact SQL と #41 です。](../../../t-sql/functions/ident-current-transact-sql.md)   
 [IDENTITY &#40;プロパティ&#41; &#40;Transact-SQL&#41;](../Topic/IDENTITY%20\(Property\)%20\(Transact-SQL\).md)   
 [sp_adjustpublisheridentityrange & #40 です。Transact SQL と #41 です。](../../../relational-databases/system-stored-procedures/sp-adjustpublisheridentityrange-transact-sql.md)  
  
  